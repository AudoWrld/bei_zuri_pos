{% extends 'base.html' %}
{% block title %}Process Return - BeiZuri Shop{% endblock %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/sales/process_sale.css' %}?v={{ STATIC_VERSION }}">

<div class="sale-container" data-sale-items="{{ sale_items_json|safe }}" data-return-items="{% if return_items_json %}{{ return_items_json|safe }}{% else %}[]{% endif %}">
  <div class="left-panel">
    <div class="scanner-section">
      <div class="scanner-input-group">
        <input type="text" id="scannerInput" class="scanner-input" placeholder="Scan products by barcode or sku" autocomplete="off" autofocus>
      </div>
    </div>

    <div class="sale-items-wrapper">
      <form method="post" id="returnForm">
        {% csrf_token %}
        <table class="sale-items-table">
           <thead>
             <tr>
               <th>Product name</th>
               <th style="text-align: center;">Sold Qty</th>
               <th style="text-align: center;">Already Returned</th>
               <th style="text-align: center;">Available</th>
               <th style="text-align: center;">Return Qty</th>
               <th style="text-align: center;">Reason</th>
               <th style="text-align: right;">Unit Price</th>
               <th style="text-align: right;">Total</th>
               <th style="text-align: center;">Confirm</th>
             </tr>
           </thead>
          <tbody id="returnItemsTable">
          </tbody>
        </table>

        <div class="control-panel">
          <div class="action-buttons">
            <button type="submit" class="btn-action btn-save" {% if not return_items %}disabled{% endif %}>
              <i class='bx bx-check'></i>
              Process Return
            </button>
            <a href="{% url 'sales:return_start' %}" class="btn-action btn-new-sale" style="text-decoration: none;">
              <i class='bx bx-arrow-back'></i>
              Back
            </a>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="right-panel">
    <div class="sale-info">
      <div class="sale-header">
        <h2>Return Details</h2>
        <div class="sale-number">{{ sale.sale_number }} - {{ sale.get_sale_type_display }}</div>
      </div>

      <div class="sale-summary">
        <div class="summary-row">
          <span class="summary-label">Items Selected</span>
          <span class="summary-value" id="itemsSelected">{{ return_items|length }}</span>
        </div>
        <div class="summary-row total">
          <span class="summary-label">Return Total</span>
          <span class="summary-value" id="returnTotal">{{ total_return_amount|default:'0.00' }}</span>
        </div>
      </div>

      <div class="sale-footer" style="padding: 15px; background: #f8f9fa; border-top: 1px solid #e0e0e0; font-size: 12px; color: #6c757d;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <span>Cashier: {{ user.get_full_name }}</span>
          <span>Time: <span id="currentTime"></span></span>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="messages-container"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const scannerInput = document.getElementById('scannerInput');
  const returnItemsTable = document.getElementById('returnItemsTable');
  const itemsSelectedEl = document.getElementById('itemsSelected');
  const returnTotalEl = document.getElementById('returnTotal');
  const returnForm = document.getElementById('returnForm');

  let saleItems = JSON.parse(document.querySelector('.sale-container').dataset.saleItems || '[]');
  let returnItems = JSON.parse(document.querySelector('.sale-container').dataset.returnItems);
  let isProcessingScan = false;
  let scanBuffer = '';
  let scanTimeout;

  function updateTotals() {
    let totalItems = returnItems.length;
    let totalAmount = 0;

    returnItems.forEach(item => {
      totalAmount += parseFloat(item.total_price);
    });

    itemsSelectedEl.textContent = totalItems;
    returnTotalEl.textContent = totalAmount.toFixed(2);

    const processBtn = returnForm.querySelector('.btn-save');
    processBtn.disabled = totalItems === 0;
  }

  function renderReturnItems() {
    returnItemsTable.innerHTML = '';
    saleItems.forEach(item => {
      const selectedItem = returnItems.find(ri => ri.sale_item_id == item.id);
      const isSelected = !!selectedItem;
      const quantity = selectedItem ? selectedItem.quantity : 1;
      const reason = selectedItem ? selectedItem.return_reason : 'FAULTY';
      const total = selectedItem ? selectedItem.total_price : (quantity * item.unit_price).toFixed(2);

      const row = document.createElement('tr');
      row.setAttribute('data-sale-item-id', item.id);
      row.innerHTML = `
        <td class="item-name">${item.name}</td>
        <td style="text-align: center;">${item.sold_quantity}</td>
        <td style="text-align: center;">${item.already_returned}</td>
        <td style="text-align: center;">${item.available}</td>
        <td style="text-align: center;">
          <input type="number" name="quantity_${item.id}" value="${quantity}" min="1" max="${item.available}" class="qty-input" style="width: 80px; text-align: center;" ${isSelected ? '' : 'disabled'}>
        </td>
        <td style="text-align: center;">
          <select name="reason_${item.id}" class="form-control" style="width: 100px; padding: 8px 10px; text-align: center; border: 2px solid #e0e0e0; border-radius: 4px; font-weight: 600; color: #00bcd4; font-size: 15px;" ${isSelected ? '' : 'disabled'}>
            <option value="FAULTY" ${reason === 'FAULTY' ? 'selected' : ''}>Faulty</option>
            <option value="PROSPECT" ${reason === 'PROSPECT' ? 'selected' : ''}>Prospect</option>
          </select>
        </td>
        <td style="text-align: right;">${item.unit_price}</td>
        <td style="text-align: right;" class="return-total">${total}</td>
        <td style="text-align: center;">
          <input type="checkbox" name="confirm_${item.id}" ${isSelected ? 'checked' : ''} ${item.available > 0 ? '' : 'disabled'}>
        </td>
      `;
      returnItemsTable.appendChild(row);
    });

    document.querySelectorAll('.qty-input').forEach(input => {
      input.addEventListener('input', function() {
        updateReturnItem(this);
      });
    });

    document.querySelectorAll('select[name^="reason_"]').forEach(select => {
      select.addEventListener('change', function() {
        updateReturnItem(this);
      });
    });

    document.querySelectorAll('input[name^="confirm_"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const saleItemId = this.name.replace('confirm_', '');
        const row = this.closest('tr');
        const qtyInput = row.querySelector('.qty-input');
        const reasonSelect = row.querySelector('select[name^="reason_"]');

        if (this.checked) {
          qtyInput.disabled = false;
          reasonSelect.disabled = false;
          const item = saleItems.find(i => i.id == saleItemId);
          returnItems.push({
            sale_item_id: item.id,
            product_name: item.name,
            sold_quantity: item.sold_quantity,
            quantity: parseInt(qtyInput.value) || 1,
            return_reason: reasonSelect.value,
            unit_price: item.unit_price.toString(),
            total_price: (parseInt(qtyInput.value) || 1) * item.unit_price
          });
        } else {
          qtyInput.disabled = true;
          reasonSelect.disabled = true;
          returnItems = returnItems.filter(ri => ri.sale_item_id != saleItemId);
        }
        updateTotals();
      });
    });
  }

  function updateReturnItem(element) {
    const row = element.closest('tr');
    const saleItemId = row.getAttribute('data-sale-item-id');
    const item = returnItems.find(ri => ri.sale_item_id == saleItemId);
    if (item) {
      const qtyInput = row.querySelector('.qty-input');
      const reasonSelect = row.querySelector('select[name^="reason_"]');
      item.quantity = parseInt(qtyInput.value) || 0;
      item.return_reason = reasonSelect.value;
      item.total_price = (item.quantity * parseFloat(item.unit_price)).toFixed(2);
      row.querySelector('.return-total').textContent = item.total_price;
      updateTotals();
    }
  }

  function scanProduct(query) {
    if (!query.trim() || isProcessingScan) return;

    isProcessingScan = true;

    fetch(`/sales/return/search-product/?sale_id={{ sale.id }}&query=${encodeURIComponent(query)}`)
      .then(response => response.json())
      .then(data => {
        if (data.success && data.products.length > 0) {
          const product = data.products[0];
          const saleItem = saleItems.find(si => si.id == product.sale_item_id);
          if (saleItem) {
            if (saleItem.available > 0) {
              const checkbox = document.querySelector(`input[name="confirm_${saleItem.id}"]`);
              if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                checkbox.dispatchEvent(new Event('change'));

                const row = checkbox.closest('tr');
                row.classList.add('highlight');
                setTimeout(() => row.classList.remove('highlight'), 300);

                const wrapper = document.querySelector('.sale-items-wrapper');
                const rowTop = row.offsetTop;
                const rowHeight = row.offsetHeight;
                const wrapperHeight = wrapper.clientHeight;
                const currentScroll = wrapper.scrollTop;

                if (rowTop < currentScroll || rowTop + rowHeight > currentScroll + wrapperHeight) {
                  wrapper.scrollTop = rowTop - wrapperHeight / 2 + rowHeight / 2;
                }

                showNotification(`Added ${product.name} to return list`, 'success');
              } else {
                showNotification(`${product.name} is already selected for return`, 'info');
              }
            } else {
              showNotification(`${product.name} has already been fully returned`, 'error');
            }
          } else {
            showNotification('Product not found in sale items', 'error');
          }
        } else {
          showNotification('Product not found in this sale', 'error');
        }
      })
      .catch(error => {
        console.error('Scan error:', error);
        showNotification('Error scanning product', 'error');
      })
      .finally(() => {
        isProcessingScan = false;
        scannerInput.value = '';
        scanBuffer = '';
      });
  }

  document.addEventListener('keydown', function(e) {
    const activeElement = document.activeElement;
    const isInputField = activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA' || activeElement.tagName === 'SELECT';
    const isQtyInput = activeElement && activeElement.classList.contains('qty-input');

    if (e.key === 'Enter') {
      if (activeElement === scannerInput) {
        e.preventDefault();
        clearTimeout(scanTimeout);
        scanProduct(scannerInput.value);
        return;
      }
      
      if (isQtyInput) {
        e.preventDefault();
        scannerInput.focus();
        return;
      }

      if (!isInputField) {
        e.preventDefault();
        if (scanBuffer.trim()) {
          scanProduct(scanBuffer.trim());
        }
        return;
      }
    }

    if (e.key === 'Escape') {
      scanBuffer = '';
      scannerInput.value = '';
      scannerInput.focus();
      return;
    }

    if (!isInputField || activeElement === scannerInput) {
      if (e.key.length === 1) {
        scanBuffer += e.key;
        if (activeElement !== scannerInput) {
          scannerInput.value = scanBuffer;
        }
        
        clearTimeout(scanTimeout);
        scanTimeout = setTimeout(() => {
          if (scanBuffer.trim()) {
            scanProduct(scanBuffer.trim());
          } else {
            scanBuffer = '';
            if (activeElement !== scannerInput) {
              scannerInput.value = '';
            }
          }
        }, 500);
      } else if (e.key === 'Backspace') {
        scanBuffer = scanBuffer.slice(0, -1);
        if (activeElement !== scannerInput) {
          scannerInput.value = scanBuffer;
        }
      }
    }
  });

  returnForm.addEventListener('submit', function(e) {
    if (returnItems.length === 0) {
      e.preventDefault();
      showNotification('Please select at least one item to return', 'error');
    }
  });

  function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    document.getElementById('currentTime').textContent = timeString;
  }

  updateTime();
  setInterval(updateTime, 1000);

  renderReturnItems();
  updateTotals();

  scannerInput.focus();
});

function showNotification(message, type = "info") {
  const container = document.querySelector(".messages-container");

  const messageDiv = document.createElement("div");
  messageDiv.className = `notification ${type}`;
  messageDiv.innerHTML = `<span>${message}</span>`;
  container.appendChild(messageDiv);
  setTimeout(() => {
    messageDiv.style.opacity = "0";
    messageDiv.style.marginRight = "-100px";
    setTimeout(() => {
      if (messageDiv.parentElement) {
        messageDiv.remove();
      }
    }, 300);
  }, 5000);
}
</script>

<style>
@keyframes highlight {
  0% { background-color: #fff3cd; }
  100% { background-color: transparent; }
}

.highlight {
  animation: highlight 0.3s ease;
}
</style>

{% endblock %}