{% extends 'base.html' %}
{% block title %}Returns History - BeiZuri Shop{% endblock %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/products/product_list.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/sales/sales_history.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="{% static 'css/sales/printer_modal.css' %}?v={{ STATIC_VERSION }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<div class="page-header">
  <h1>Returns History</h1>
  <div class="header-actions">
    <a href="{% url 'sales:return_start' %}" class="btn btn-primary">Start Return</a>
  </div>
</div>

<div class="filter-container">
  <form method="get" class="filter-form">
    <div class="filter-group">
      <label for="search">Search:</label>
      <input type="text" id="search" name="search" value="{{ search_query }}" placeholder="Search returns..." class="search-input">
    </div>
    <div class="filter-group">
      <label for="start_date">From:</label>
      <input type="text" id="start_date" name="start_date" value="{{ start_date }}" class="date-input" placeholder="Select start date">
    </div>
    <div class="filter-group">
      <label for="end_date">To:</label>
      <input type="text" id="end_date" name="end_date" value="{{ end_date }}" class="date-input" placeholder="Select end date">
    </div>
    <div class="filter-group">
      <button type="submit" class="btn btn-primary filter-btn">Filter</button>
    </div>
  </form>
</div>

<div class="table-container">
  <table class="data-table">
    <thead>
      <tr>
        <th>
          <a href="?sort={% if current_sort == 'return_number' %}-return_number{% else %}return_number{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="sort-link">
            Return Number
            {% if current_sort == 'return_number' %}<i class='bx bx-chevron-up'></i>{% elif current_sort == '-return_number' %}<i class='bx bx-chevron-down'></i>{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort={% if current_sort == 'sale__sale_number' %}-sale__sale_number{% else %}sale__sale_number{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="sort-link">
            Sale Number
            {% if current_sort == 'sale__sale_number' %}<i class='bx bx-chevron-up'></i>{% elif current_sort == '-sale__sale_number' %}<i class='bx bx-chevron-down'></i>{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort={% if current_sort == 'cashier__username' %}-cashier__username{% else %}cashier__username{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="sort-link">
            Cashier
            {% if current_sort == 'cashier__username' %}<i class='bx bx-chevron-up'></i>{% elif current_sort == '-cashier__username' %}<i class='bx bx-chevron-down'></i>{% endif %}
          </a>
        </th>
        <th>Items</th>
        <th>
          <a href="?sort={% if current_sort == 'total_return_amount' %}-total_return_amount{% else %}total_return_amount{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="sort-link">
            Return Amount (Ksh)
            {% if current_sort == 'total_return_amount' %}<i class='bx bx-chevron-up'></i>{% elif current_sort == '-total_return_amount' %}<i class='bx bx-chevron-down'></i>{% endif %}
          </a>
        </th>
        <th>
          <a href="?sort={% if current_sort == 'created_at' %}-created_at{% else %}created_at{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}" class="sort-link">
            Date
            {% if current_sort == 'created_at' %}<i class='bx bx-chevron-up'></i>{% elif current_sort == '-created_at' %}<i class='bx bx-chevron-down'></i>{% endif %}
          </a>
        </th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for return_obj in page_obj %}
      <tr>
        <td>{{ return_obj.return_number }}</td>
        <td>{{ return_obj.sale.sale_number }}</td>
        <td>{{ return_obj.cashier.get_full_name|default:return_obj.cashier.username }}</td>
        <td>{{ return_obj.items.count }}</td>
        <td>{{ return_obj.total_return_amount }}</td>
        <td>{{ return_obj.created_at|date:"M d, Y H:i" }}</td>
        <td>
          <a href="{% url 'sales:return_detail' return_obj.id %}" class="action-link">View</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="7">
          <div class="pagination">
            {% if page_obj.has_previous %}
              <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}"><i class='bx bx-chevrons-left'></i></a>
              <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}"><i class='bx bx-chevron-left'></i></a>
            {% else %}
              <span class="disabled"><i class='bx bx-chevrons-left'></i></span>
              <span class="disabled"><i class='bx bx-chevron-left'></i></span>
            {% endif %}
            <span class="current-page">{{ page_obj.number }}</span>
            {% if page_obj.has_next %}
              <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}"><i class='bx bx-chevron-right'></i></a>
              <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if start_date %}&start_date={{ start_date }}{% endif %}{% if end_date %}&end_date={{ end_date }}{% endif %}{% if current_sort %}&sort={{ current_sort }}{% endif %}"><i class='bx bx-chevrons-right'></i></a>
            {% else %}
              <span class="disabled"><i class='bx bx-chevron-right'></i></span>
              <span class="disabled"><i class='bx bx-chevrons-right'></i></span>
            {% endif %}
          </div>
        </td>
      </tr>
    </tfoot>
  </table>
</div>

{% if not page_obj %}
<div class="no-results">
  <p>No returns found for the selected period.</p>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  flatpickr("#start_date", {
    dateFormat: "Y-m-d",
    maxDate: "today",
    onChange: function(selectedDates, dateStr, instance) {
      const endDatePicker = document.querySelector("#end_date")._flatpickr;
      if (endDatePicker) {
        endDatePicker.set('minDate', dateStr);
      }
    }
  });

  flatpickr("#end_date", {
    dateFormat: "Y-m-d",
    maxDate: "today",
    minDate: document.getElementById('start_date').value || null
  });
});
</script>
{% endblock %}